<p>
  <strong>Id #:</strong>
  <%= @game_state.game.guid %>
</p>

<p id="current-players">
  <b>Players:</b>
  <% @game_state.game.players.each do |player| %>
    <br>
    <%= player.email %>
  <% end %>
</p>

<!-- SCRAP FORM -->
<p>
   <b>Take Scrap:</b>
   <%= form_tag("/game_states/#{@game_state.id}/draw/scrap", remote: true) do %>
      <%= token_tag nil %>
      <select name="card_id">
         <option>Choose a scrap</option>
         <% Scrap.all.each do |scrap| %>
            <option value="<%= scrap.id %>"><%= scrap.name %></option>
         <% end %>
      </select>
      <input type="submit" value="Draw"></input>
   <% end %>
</p>

<!-- BLUEPRINT FORM  -->
<p>
   <b>Take Blueprint:</b>
   <%= form_tag("/game_states/#{@game_state.id}/draw/blueprint", remote: true) do %>
      <%= token_tag nil %>
      <select id="blueprint-select" name="card_id">
         <option>Choose a blueprint</option>
         <% @game_state.game.available_blueprints.each do |blueprint| %>
            <option value="<%= blueprint.id %>">
               <%= blueprint.scrapper_module.name %>
            </option>
         <% end %>
      </select>
      <input type="submit" value="Draw"></input>
   <% end %>
</p>

<!-- RAW MATERIALS -->
<p id="player-materials" style="color: red;">
   <b>Raw Materials:</b> <%= @game_state[:raw] || 0 %>
</p>

<!-- HELD SCRAPS -->
<p style="color: gray;">
   <b>Held Scraps:</b>
   <ul id="held-scraps" style="color: gray;">
      <% @game_state.scrap_holds.each do |hold| %>
         <li>
            <%= hold.scrap.name %> |
            <%= link_to 'Use' %> |
            <%= link_to 'Sell' %> |
            <%= link_to 'Trade' %>
         </li>
      <% end %>
   </ul>
<p>

<!-- HELD BLUEPRINTS -->
<p style="color: blue;">
   <b>Held Blueprints:</b>
   <ul id="held-blueprints" style="color: blue;">
      <% @game_state.blueprint_holds.each do |hold| %>
         <li>
            <%= hold.blueprint.name %> |
            <%= link_to 'Build' %> |
            <%= link_to 'Trade' %> |
            <%= link_to 'Discard' %>
         </li>
      <% end %>
   </ul>
</p>

<!-- HELD SCRAPPER MODULES -->
<p style="color: green;">
   <b>Held Scrapper Modules:</b>
   <ul id="held-modules">
      <% @game_state.module_holds.each do |hold| %>
         <li>
            <%= hold.scrapper_modules.name %> |
            <%= link_to 'Trade' %>
         </li>
      <% end %>
   </ul>
</p>

<%= link_to 'Forfeit' %>

<script>
   var stateSource = new EventSource(
      "/game_states/" + <%= @game_state.id %> + ".json"
   );

   stateSource.addEventListener("update", function(event) {
      var data = JSON.parse(event.data);

      renderPlayers(data.players);
      renderBlueprintSelect(data.available_blueprints);

      renderTurnStatus(data.is_my_turn);
      renderRawMaterials(data.raw);

      renderHeldScraps(data.scraps);
      renderHeldBlueprints(data.blueprints);
      renderHeldModules(data.scrapper_modules);
   });

   function renderBlueprintSelect(blueprints) {
      if (blueprints && blueprints.length) {
         var blueprintFormHTML = "<option>Choose a blueprint</option>";

         for (var blueprint of blueprints) {
            blueprint = JSON.parse(blueprint);

            blueprintFormHTML +=
               "<option value='" +
               blueprint.id +
               "'>" +
               blueprint.name +
               "</option>"
         }

         $("#blueprint-select").html(blueprintFormHTML);
      }
   }

   function renderHeldScraps(scraps) {
      if (scraps && scraps.length) {
         var heldScrapsHTML = "";

         for (var scrap of scraps) {
            scrap = JSON.parse(scrap);

            heldScrapsHTML += "<li>" +
               scrap.name +
               ` | <%= link_to 'Use' %>` +
               ` | <%= link_to 'Sell' %>` +
               ` | <%= link_to 'Trade' %>` +
               "</li>"
         }

         $("#held-scraps").html(heldScrapsHTML);
      } else $("#held-scraps").html("No Held Scraps");
   }

   function renderHeldBlueprints(blueprints) {
      if (blueprints && blueprints.length) {
         var heldBlueprintsHTML = "";

         for (var blueprint of blueprints) {
            blueprint = JSON.parse(blueprint);

            heldBlueprintsHTML += "<li>" +
               blueprint.name +
               ` | <%= link_to 'Build' %>` +
               ` | <%= link_to 'Discard' %>` +
               ` | <%= link_to 'Trade' %>` +
               "</li>"
         }

         $("#held-blueprints").html(heldBlueprintsHTML);
      } else $("#held-blueprints").html("No Held Blueprints");
   }

   function renderHeldModules(modules) {
      if (modules && modules.length) {
         var heldModulesHTML = "";

         for (var scrapper_module of modules) {
            scrapper_module = JSON.parse(scrapper_module);

            heldModulesHTML += "<li>" +
               scrapper_module.name +
               ` | <%= link_to 'Trade' %>` +
               "</li>"
         }

         $("#held-modules").html(heldModulesHTML);
      } else $("#held-modules").html("No Held Modules");
   }

   function renderPlayers(players) {
      if (players) {
         var playerHTML = "<b>Players:</b>";

         for (var player of players) {
            playerHTML += ("<br>" + player);
         }

         $("#current-players").html(playerHTML);
      }
   }

   function renderRawMaterials(raw) {
      if (raw) {
         var rawMaterialsHTML = "<b>Raw Materials:</b>" + data.raw;

         $("#player-materials").html(rawMaterialsHTML);
      }
   }

   function renderTurnStatus(status) {
      if (status) {

      }
   }
</script>
