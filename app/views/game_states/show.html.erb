<script>
     var time = new Date().getTime();
     $(document.body).bind("mousemove keypress", function(e) {
         time = new Date().getTime();
     });

     function refresh() {
         if(new Date().getTime() - time >= 10000)
             window.location.reload(true);
         else
             setTimeout(refresh, 3000);
     }

     setTimeout(refresh, 3000);
</script>

<% if @game_state.is_my_turn %>
  <h1 style="color:green;">
    <strong>Game #</strong> <%= @game_state.game.guid %>
  </h1>

  <style>
    body {
      background: rgb(184, 214, 193) !important;
    }
  </style>
<% else %>
  <h1>
    <strong>Game #</strong> <%= @game_state.game.guid %>
  </h1>
<% end %>

<p>
  <h3>Players:</h3>
  <table id="current-players" width="100%">
    <% @game_state.siblings.each do |player_state| %>
      <tr width="100%">
        <td>
          <% if player_state.is_my_turn %>
            <span style="color: green;">
              <%= player_state.player.email %>
            </span>
          <% else %>
            <span>
              <%= player_state.player.email %>
            </span>
          <% end %>

          <% if player_state.player.id == current_player.id %>
            <% if player_state.is_my_turn %>
              <b style="color:green;">(me)</b>
            <% else %>
              <b>(me)</b>
            <% end %>
          <% end %>
        </td>

        <td width="75">
          <% if player_state.player.id == current_player.id %>
            <% if player_state.is_my_turn %>
              <%= button_to 'End Turn', game_state_path(@game_state), method: :put, params: { is_my_turn: false } %>
            <% end %>
          <% elsif @game_state.game.has_started && !@game_state.is_my_turn %>
            <%= button_to 'Trade', new_game_state_trade_path(player_state), method: :get %>
          <% end %>

          <% unless @game_state.game.has_started %>
            <% if player_state.is_ready %>
              <span style="color: green;">Ready!</span>
            <% end %>
            <% if player_state.player.id == current_player.id && !player_state.is_ready %>
              <%= button_to 'Ready', game_state_path(@game_state), method: :put, params: { is_ready: true } %>
            <% end %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>
</p>

<section id="game-state">
  <% if @game_state.game.has_started %>

      <div class="panel panel-default">
          <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                  <a data-toggle="collapse" data-parent="#accordion" href="#takeCards" aria-expanded="true" aria-controls="takeCards">
                      Take Cards
                  </a>
              </h4>
          </div>
          <div id="takeCards" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
            <% if @game_state.is_my_turn %>
              <!-- SCRAP FORM -->
              <p>
                  <%= render "scrap_holds/form", game_state: @game_state %>
              </p>
            <% end %>

              <!-- BLUEPRINT FORM  -->
              <p>
                  <%= render "blueprint_holds/form", game_state: @game_state %>
              </p>
          </div>
      </div>

    <!-- RAW MATERIALS -->
    <p id="player-materials" style="color: red;">
        <h3>
            Cash: $<%= @game_state[:raw] || 0 %>
        </h3>
    </p>

    <div id="accordion" role="tablist" aria-multiselectable="true">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingOne">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#heldScraps" aria-expanded="true" aria-controls="heldScraps">
                        Held Scraps (<%= @game_state.scrap_holds.count %>)
                    </a>
                </h4>
            </div>
            <div id="heldScraps" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                <table width="100%" id="held-scraps" style="color: gray;">
                    <% if @game_state.scrap_holds.count > 0 %>
                    <% @game_state.scrap_holds.each do |hold| %>
                    <% if !!hold.scrap %>
                    <tr>
                        <td>
                          <%= hold.scrap.name %>
                        </td>
                        <td width="100" style="color: green;">
                          Value: $<%= hold.value %>
                        </td>
                        <% unless @game_state.is_my_turn %>
                          <td width="65">
                            <%= button_to 'Sell', hold, method: :delete, params: { sell: true }  %>
                          </td>
                        <% end %>
                        <td width="65">
                          <%= button_to 'Discard', hold, method: :delete, data: { confirm: 'Are you sure?' } %>
                        </td>
                    </tr>
                    <% end %>
                    <% end %>
                <% else %>
                    No Held Scraps
                    <% end %>
                </table>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingTwo">
                <h4 class="panel-title">
                    <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                      Held Blueprints (<%= @game_state.blueprint_holds.count %>)
                    </a>
                </h4>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
                <table width="100%" id="held-blueprints" style="color: blue;">
                  <% if @game_state.blueprint_holds.count > 0 %>
                    <% @game_state.blueprint_holds.each do |hold| %>
                      <% if !!hold.blueprint %>
                        <tr>
                          <td>
                            <%= hold.blueprint.name.titleize %>
                          </td>
                            <% if (hold.build_options.length > 0) && !@game_state.is_my_turn %>
                              <td width="65">
                                <%= button_to 'Build', new_blueprint_hold_module_hold_path(hold), method: :get %>
                              </td>
                            <% elsif (hold.build_options.length > 0) %>
                              <td width="65" style="color:green;">âœ“</td>
                            <% end %>
                            <td width="65">
                              <%= button_to 'Pass', hold, method: :delete, data: { confirm: 'Are you sure?' } %>
                            </td>
                        </tr>
                      <% end %>
                    <% end %>
                <% else %>
                    No Held Blueprints
                    <% end %>
                </table>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingThree">
                <h4 class="panel-title">
                    <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                        Held Scrapper Guts (<%= @game_state.module_holds.count %>)
                    </a>
                </h4>
            </div>
            <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
                <ul id="held-modules">
                  <% if @game_state.module_holds.count > 0 %>
                    <% @game_state.module_holds.each do |hold| %>
                      <li><%= hold.scrapper_module.name.titleize %></li>
                    <% end %>
                  <% else %>
                    No Guts
                  <% end %>
                </ul>
            </div>
        </div>

        <% if @game_state.actionable_trades.count > 0 %>
          <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="headingFour">
              <h4 class="panel-title">
                <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#tradeProposals" aria-expanded="false" aria-controls="tradeProposals">
                  Trade Proposals (<%= @game_state.actionable_trades.count %>)
                </a>
              </h4>
            </div>
            <div id="tradeProposals" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFour">
              <table id="trade-proposals" width="100%">
                <% @game_state.actionable_trades.each do |trade| %>
                  <tr width="100%">
                    <td>
                      <%= trade.other_player(current_player).email %>
                    </td>

                    <td width="75">
                      <%= link_to 'Review', trade_path(trade) %>
                    </td>
                  </tr>
                <% end %>
              </table>
            </div>
          </div>
        <% end %>
    </div>
  <% else %>
    <ul>
      <li>Keep refreshing the page.</li>
      <li>Don't click ready until everyone is listed here!</li>
      <li>Then, refresh until you can see the UI.</li>
    </ul>
  <% end %>
</section>

<%= button_to 'Leave Game', game_state_path(@game_state), data: { confirm: 'Are you sure?' }, method: :delete %>
